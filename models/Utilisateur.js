const mongoose = require("mongoose");
const validator = require("validator");
const jwt = require('jsonwebtoken')
const bcrypt = require('bcryptjs')
const Schema = mongoose.Schema;

const utilisateurSchema = new Schema({
  nom: {
    type: String,
    trim: true,
    required: true,
    minlength: 3
  },
  prenom: {
    type: String,
    trim: true,
    required: true,
    minlength: 3
  },
  pseudo: {
    type: String,
    required: true,
    minlength: 3
  },
  description: {
    type: String,
  },
  mail: {
    type: String,
    required: true,
    trim: true,
    lowercase: true,
    unique: true,
    validate(value) {
      if (!validator.isEmail(value)) {
        throw new Error("Le mail n'est pas valide");
      }
    },
  },
  mot_de_passe: {
    type: String,
    required: true,
    minlength: 8,
    trim: true,
    validate(value) {
      if (value.toLowerCase().includes("motdepasse")) {
        throw new Error('Mot de passe ne peut pas contenir "motdepasse"');
      }
    },
  },
  nbdabonne: {
    type: Number,
    default: 0,
    validate(value) {
      if (value < 0) {
        throw new Error(
          "Le nombre d'abonné ne peut pas être un nombre négatif"
        );
      }
    },
  },
  nbdabonnement: {
    type: Number,
    default: 0,
    validate(value) {
      if (value < 0) {
        throw new Error(
          "Le nombre d'abonnement ne peut pas être un nombre négatif"
        );
      }
    },
  },
  date_creation: {
    type: Date,
    required: true,
    default: Date.now,
  },
  compte_actif: {
    type: Boolean,
    default: false,
  },
  image: {
    type: String,
    required: false,
    default: "data:image/png;base64,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"
    },
  tokens: [{
    token: {
        type: String,
        required: true
    }
}],
  role: {
    type: Schema.Types.ObjectId,
    ref: "Role",
    default: "623b03b7b994734c2c18628f",
  },
});

utilisateurSchema.virtual('ressources', {
  ref: 'Ressource',
  localField: '_id',
  foreignField: 'ressources'
})

utilisateurSchema.pre('save', async function (next) {
  const utilisateur = this;

  if (utilisateur.isModified('mot_de_passe')) {
    utilisateur.mot_de_passe = await bcrypt.hash(utilisateur.mot_de_passe, 8);
  }

  next();
});


utilisateurSchema.methods.generateAuthToken = async function () {
  const utilisateur = this;

  const token = jwt.sign({ _id: utilisateur._id.toString() }, 'eroighaoeijgrpaojegp54546');
  utilisateur.tokens = utilisateur.tokens.concat({ token });
  await utilisateur.save();
  return token;
};



utilisateurSchema.statics.findByCredentials = async (mail, mot_de_passe) => {
  const utilisateur = await Utilisateur.findOne({ mail });
  if (!utilisateur) {
      throw new Error('Mauvais identifiants');
  }
  const compareOk= await bcrypt.compare(mot_de_passe, utilisateur.mot_de_passe);
  if (!compareOk) {
      throw new Error('Mauvais identifiants');
  }

  return utilisateur;
};


utilisateurSchema.pre('delete', async function (next) {
  const utilisateur = this;
  await Ressource.deleteMany({ owner: user._id });
  next();
});

utilisateurSchema.methods.toJSON = function () {
  const utilisateur = this;
  const utilisateurObject = utilisateur.toObject();

  delete utilisateurObject.mot_de_passe;
  delete utilisateurObject.tokens;
  delete utilisateurObject.image;

  return utilisateurObject;
};

const Utilisateur = mongoose.model('Utilisateur', utilisateurSchema)
module.exports = Utilisateur;
